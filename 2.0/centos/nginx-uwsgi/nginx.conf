###################
# This is property of eXtremeSHOK.com
# You are free to use, modify and distribute, however you may not remove this notice.
# Copyright (c) Adrian Jon Kriel :: admin@extremeshok.com
##################

user nginx;
worker_processes 4;
worker_priority -10;
pid /var/run/nginx.pid;

worker_rlimit_nofile 51200;
timer_resolution 100ms;

error_log /var/log/nginx/error.log;

events {
    worker_connections 4096;
    use epoll;
    # multi_accept on;
}

http {

    ##
    # Basic Settings
    ##

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    
    keepalive_disable msie6;
    keepalive_timeout 65;

    server_tokens off;

    types_hash_max_size 2048;
    server_names_hash_bucket_size 1024;
    proxy_headers_hash_max_size 2048;
    proxy_headers_hash_bucket_size 1024;

    server_name_in_redirect off;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    charset utf-8;

    ##
    # Logging Settings
    ##

    log_format      main    '$remote_addr - $remote_user [$time_local] $request '
    '"$status" $body_bytes_sent "$http_referer" '
    '"$http_user_agent" "$http_x_forwarded_for" "$gzip_ratio"'
    ' "$connection" "$connection_requests" "$request_time"';
    
    access_log /var/log/nginx/access.log combined buffer=32k;
    
    ##
    # Gzip Settings
    ##

    gzip on;
    gzip_vary  on;
    gzip_disable "MSIE [1-6]\.";
    gzip_static on;
    gzip_proxied  any;
    gzip_min_length   1400;
    gzip_comp_level 6;
    gzip_buffers  32 8k;
    gzip_http_version 1.0;
    # Turn on gzip for all content types that should benefit from it.
    gzip_types application/ecmascript;
    gzip_types application/javascript;
    gzip_types application/json;
    gzip_types application/pdf;
    gzip_types application/postscript;
    gzip_types application/x-javascript;
    gzip_types application/xml;
    gzip_types application/xml+rss;
    gzip_types image/svg+xml;
    gzip_types text/css;
    gzip_types text/csv;
    # "gzip_types text/html" is assumed.
    gzip_types text/javascript;
    gzip_types text/plain;
    gzip_types text/xml;
    
    ##
    # Buffers
    ##

    client_body_buffer_size 256k;
    client_body_in_file_only off;
    client_body_timeout 90s;
    client_header_buffer_size 256k;
    ## how long a connection has to complete sending 
    ## it's headers for request to be processed
    client_header_timeout  30s;
    client_max_body_size 1024k; 
    connection_pool_size  512;
    directio  4m;
    ignore_invalid_headers on;       
    large_client_header_buffers 8 256k;
    output_buffers   8 256k;
    postpone_output  1460;
    proxy_temp_path  /tmp/nginx_proxy/;
    request_pool_size  128k;
    reset_timedout_connection on;
    send_timeout     90s;

    ##
    # File cache
    ##
    open_file_cache max=5000 inactive=30s;
    open_file_cache_valid 120s;
    open_file_cache_min_uses 2;
    open_file_cache_errors off;
    open_log_file_cache max=1024 inactive=30s min_uses=2;

    ## limit number of concurrency connections per ip to 16
    ## add to your server {} section the next line
    ## limit_conn limit_per_ip 16;
    ## uncomment below line allows 1million sessions
    limit_conn_log_level error;
    #######################################
    # use limit_conn_zone for Nginx >v1.1.8 and higher
    limit_conn_zone $binary_remote_addr zone=limit_per_ip:32m;
    #######################################

    # for nginx proxy backends to prevent redirects to backend port 
    # port_in_redirect off;

    ##
    # nginx-naxsi config
    # Uncomment it if you installed nginx-naxsi
    ##
    #include /etc/nginx/naxsi_core.rules;

	uwsgi_cache_path /tmp/uwsgi_cache  levels=1:2  keys_zone=NAME:10m inactive=5m;

	server {
		listen 80 default_server;
	    listen [::]:80 default_server;
		server_name _;

		#listen  443 ssl spdy;    

		#ssl_certificate      /etc/ssl/secure/extremeshok.com.pem;
		#ssl_certificate_key  /etc/ssl/secure/extremeshok.com.key.nopass;
		
		#include /etc/nginx/includes/ssl.conf;
		
		root /home/baruwa/px/lib/python2.6/site-packages/baruwa/public;

		access_log /var/log/nginx/baruwa-access.log combined buffer=32k;
		error_log /var/log/nginx/baruwa-error.log debug;

		location = /favicon.ico  {  root /home/baruwa/px/lib/python2.6/site-packages/baruwa/public/imgs; access_log off; log_not_found off; expires 30d; add_header Cache-Control "public"; break; }
		location = /robots.txt { access_log off; log_not_found off; break;  } 
		location ~ /\.          { access_log off; log_not_found off; deny all; break;  }
		location ~ ~$           { access_log off; log_not_found off; deny all; break; }
		location ~ /\.git { access_log off; log_not_found off; deny all; break; }
		location ~* /\.(tpl|htaccess|htpasswd|ini|phps|fla|psd|log|sh)$ { access_log off; log_not_found off; deny all; break; }
		location ~*/(imgs|js|css)/ { root /home/baruwa/px/lib/python2.6/site-packages/baruwa/public; access_log off; log_not_found off; expires 30d; add_header Cache-Control "public"; break; }

		# limit_conn limit_per_ip 16;
		# ssi  on;
		
		location / {
			uwsgi_pass unix:///var/run/uwsgi/baruwa.sock;
		   
			##
			# Uncomment to enable page caching
			##
			#uwsgi_cache         NAME;
			#uwsgi_cache_key     $host$request_uri;
			#uwsgi_cache_valid   200 302  1h;
			#uwsgi_cache_valid   301      1d;
			#uwsgi_cache_valid   any      1m;
			#uwsgi_cache_min_uses  1;
			#uwsgi_cache_use_stale error  timeout invalid_header http_500;

			include uwsgi_params;
			uwsgi_param SCRIPT_NAME '';
			uwsgi_param UWSGI_SCHEME $scheme;
		}

	}
	
    ##
    # Virtual Host Configs
    ##

    include /etc/nginx/conf.d/*.conf;
}
###################
# This is property of eXtremeSHOK.com
# You are free to use, modify and distribute, however you may not remove this notice.
# Copyright (c) Adrian Jon Kriel :: admin@extremeshok.com
##################